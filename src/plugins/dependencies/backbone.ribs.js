(function(e,t){"use strict";if(typeof exports!=="undefined"){module.exports=t(require("underscore"),require("backbone"))}else if(typeof define==="function"&&define.amd){define(["underscore","backbone"],t)}else{t(e._,e.Backbone)}})(this,function(e,t){"use strict";var n=t.Ribs={version:"0.4.2"};var r=function(e,t,n){return e._super.prototype[t].apply(e,n)};var i=function(e){if(e.indexOf("!.")===-1){return e.split(".")}var t=[],n,r,i,s,o,u,a;e=e.split("!.");n=e.length;for(u=0;u<n;u++){o=e[u].split(".");r=o.length;if(s!==undefined){s+="."+o[0];if(r>1){t.push(s)}else{if(u+1===n){t.push(s)}continue}a=1}else{a=0}if(u+1<n){i=r-1;s=o[r-1]}else{i=r}for(;a<i;a++){t.push(o[a])}}return t};var s=function(e,t){var n,r,s;if(typeof e==="string"){e=i(e)}for(r=0,s=e.length;r<s;r++){n=e[r];if(t.hasOwnProperty(n)){t=t[n]}else{if(s>r+1){throw new Error("can't get \""+e[r+1]+'" of "'+n+'", "'+n+'" is undefined')}else{return undefined}}}return t};var o=function(e,t){var n;for(var r=0,i=e.length;r<i;r++){n=e[r];if(r+1===i){delete t[n]}else{if(t.hasOwnProperty(n)){t=t[n]}else{break}}}};var u=function(e){var t=e.match(/^(?:!\.|[^.])+/),n,r;try{n=t[0];r=e.slice(n.length+1);if(!r.length||!n.length){throw""}}catch(i){throw new Error('wrong binging data"'+e+'"')}return{model:n,attr:r}};var a=function(e,t,n){this.name=t;if(typeof e==="function"){this.get=function(){return e.apply(n)};this.set=function(){throw new Error('set: computed "'+t+'" has no set method')};this._simple=true;return this}this._deps=e.deps;this._get=e.get;this.set=function(){return e.set.apply(n,arguments)};this._model=n;return this};e.extend(a.prototype,{update:function(t){if(this._simple){return}var n=[],r;this._previous=this.value;if(this._deps instanceof Array){for(var i=0,s=this._deps.length;i<s;i++){try{r=this._model.get(this._deps[i])}catch(o){r=undefined}n.push(r)}}this.value=this._get.apply(this._model,n);if(!e.isEqual(this._previous,this.value)){this._model.trigger("change:"+this.name,this._model,this.value,t)}},get:function(){return this.value}});var f=function(e,t,n){var r;this.selector=t;this.view=e;this.mods={};this._hasInDOMHandler=n.hasOwnProperty("inDOM");this._setEl();this.handlers={};for(var i in n){if(n.hasOwnProperty(i)){r=n[i];if(r instanceof Array){for(var s=0,o=r.length;s<o;s++){this._addHandler(i,r[s])}}else{this._addHandler(i,r)}}}};e.extend(f.prototype,{_addHandler:function(e,t){var n=this.view.handlers[e],r=e==="collection";if(!r&&!n){throw new Error('unknown handler type "'+e+'"')}if(!r&&n.multiple){for(var i in t){if(t.hasOwnProperty(i)){this.addHandler(e,t[i],i)}}}else{if(r){this.addColHandler(t)}else{this.addHandler(e,t)}}},addColHandler:function(e){var t=this.view,n=typeof e.view==="string"?t[e.view]:e.view,r=typeof e.col==="string"?t[e.col]:e.col,i=e.data||{},s=this.selector,o={},u=this,a;if(s==="el"){a=t.$el}else{a=t.$(s)}r.on("sort",this._onsort,this);r.on("add",this._onaddView,this);r.on("remove",this._removeView,this);r.on("reset",this._onReset,this);this.handlers.collection={collection:r,$el:a,View:n,data:i,views:o};var f=r.set;r.set=function(){var e=f.apply(r,arguments);if(u._toAdd){u._fillElByCollection()}u._toAdd=undefined;return e};this._fillElByCollection()},_fillElByCollection:function(n){var r=this.handlers.collection,i=r.collection,s=r.views,o=r.data,u=r.View,a=r.$el,f=document.createDocumentFragment(),l=this._toAdd,c,h,p,d,v;n=n||{};for(d=0,v=i.length;d<v;d++){h=i.at(d);p=h.cid;c=s[p];if(!c&&!n.withoutNewView&&(!l||l[p])){c=new u(e.extend(o,{model:h,collection:i}));s[p]=c}if(c){f.appendChild(c instanceof t.Ribs.View?c.getEl()[0]:c.el)}}a.append(f)},addHandler:function(e,n,r){var s=n.data,o=n.filter,a=n.events||"change",f=this.view.filters,l=[],c=[],h=[],p={},d=this,v={changeAttrs:p},m=this.view.handlers[e],g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_;if(typeof m!=="function"){g=m.get;m=m.set}if(typeof n==="string"){l.push(u(n))}else{if(typeof s==="string"){l.push(u(s))}else if(s instanceof Array){for(A=0,O=s.length;A<O;A++){l.push(u(s[A]))}}else{throw new Error("wrong binging format "+JSON.stringify(n))}}if(o){if(typeof o==="string"){if(!f.hasOwnProperty(o)){throw new Error('unknown filter "'+o+'"')}o=f[o]}if(typeof o==="function"){y=o}else{y=o.get;b=o.set}}if(m){k=function(){var e=[],i=d.view,s,o,u,a,f;for(a=0,f=l.length;a<f;a++){u=l[a];s=u.model;o=u.attr;if(i[s]instanceof t.Collection){e.push(i[s].pluck(o))}else{e.push(i[s].get(o))}}if(y){o=y.apply(i,e)}else{o=e[0]}m.call(d,d.$el,o,r,n)}}if(g){if(l.length>1){throw new Error("wrong binging format "+JSON.stringify(n))}L=function(){var e=g.call(d,d.$el);if(b){e=b.call(d.view,e)}d.view[l[0].model].set(S,e)}}for(A=0,O=l.length;A<O;A++){w=l[A];E=w.model;S=w.attr;x=i(S);N="";C=p[E]=[];if(this.view[E]instanceof t.Collection){c.push(this.view[E].pluck(S));if(m){if(h.indexOf(E)===-1){h.push(E);this.view[E].on("add remove reset sort",k)}}}else{c.push(this.view[E].get(S))}if(m){for(M=0,_=x.length;M<_;M++){if(N){N+="."}N+=x[M];C.push(N);this.view[E].on("change:"+N,k)}}}if(y){T=y.apply(this.view,c)}else{T=c[0]}if(m){m.call(this,this.$el,T,r,n);v.setter=k}if(g){this.view.$el.on(a+".bindingHandlers",this.selector,L);v.getter=L;v.events=a}this.handlers[e]=v},unbind:function(e){var n=this.handlers,r=[],i,s,o,u,a,f,l,c;for(var h in n){if(n.hasOwnProperty(h)&&!(e&&e.indexOf("all")===-1&&e.indexOf(h)===-1)){o=n[h];u=o.setter;a=o.events;if(a){this.view.$el.off(a+".bindingHandlers",this.selector,o.getter)}if(typeof u==="function"){i=o.changeAttrs;for(f in i){if(i.hasOwnProperty(f)){if(this.view[f]instanceof t.Collection){if(r.indexOf(f)===-1){r.push(f);this.view[f].off("add remove reset sort",u)}}s=i[f];for(l=0,c=s.length;l<c;l++){this.view[f].off("change:"+s[l],u)}}}}if(h==="collection"){var p=o.collection,d=o.views,v;p.off("sort",this._onsort,this);p.off("add",this._onaddView,this);p.off("remove",this._removeView,this);p.off("reset",this._onReset,this);for(v in d){if(d.hasOwnProperty(v)){d[v].remove()}}}if(h==="inDOM"){var m=this.$el,g=this.dummies,y,b;for(l=0,c=m.length;l<c;l++){y=m[l];b=g[l];if(!y.parentNode&&b.parentNode){b.parentNode.replaceChild(y,b)}}if(this.selector==="el"){this.view._ribs.outOfDOM=false}this.dummies=[]}delete n[h]}}},update:function(e){var t=this.handlers,n,r;for(var i in t){if(t.hasOwnProperty(i)&&!(e&&e.indexOf("all")===-1&&e.indexOf(i)===-1)){n=t[i];r=n.setter;if(typeof r==="function"){this._setEl();r()}if(i==="collection"){this._fillElByCollection()}}}},_setEl:function(){var e=this.selector,t;if(e==="el"){this.$el=this.view.$el}else{this.$el=this.view.$(e)}if(this._hasInDOMHandler){this.dummies=[];for(var n=0;n<this.$el.length;n++){t=document.createElement("div");t.style.display="none";t.className="ribsDummy";this.dummies.push(t)}if(e==="el"){this.view._$el=$(this.dummies[0]);this.view._el=this.view._$el[0]}else{this.view._$el=null;this.view._el=null}}},_onsort:function(){if(!this._toAdd){this._fillElByCollection({withoutNewView:true})}},_onaddView:function(e){if(!this._toAdd){this._toAdd={}}this._toAdd[e.cid]=e},_removeView:function(e){var t=this.handlers.collection,n=t.views[e.cid];n.remove();delete t.views[e.cid]},_onReset:function(){var e=this.handlers.collection,t=e.views,n;for(n in t){if(t.hasOwnProperty(n)){t[n].remove()}}e.views={};this._fillElByCollection()}});var l={not:function(e){return!e},length:function(e){if(e.hasOwnProperty("length")){return e.length}else{return 0}}};var c={text:function(e,t){e.text(t)},value:{set:function(e,t){if(e.val()!==t){e.val(t)}},get:function(e){return e.val()}},css:{set:function(e,t,n){e.css(n,t)},multiple:true},attr:{set:function(e,t,n){e.attr(n,t)},multiple:true},classes:{set:function(e,t,n){e.toggleClass(n,!!t)},multiple:true},html:function(e,t){e.html(t)},inDOM:function(e,t){var n,r;if(this.selector==="el"){this.view._ribs.outOfDOM=!t}for(var i=0;i<e.length;i++){r=e[i];n=this.dummies[i];if(t){if(!r.parentNode&&n.parentNode){n.parentNode.replaceChild(r,n)}}else{if(r.parentNode){r.parentNode.replaceChild(n,r)}}}},toggle:function(e,t){e.toggle(!!t)},disabled:function(e,t){e.prop("disabled",!!t)},enabled:function(e,t){e.prop("disabled",!t)},checked:{set:function(e,t){e.prop("checked",false);if(t instanceof Array){for(var n=0,r=t.length;n<r;n++){e.filter('[value="'+t[n]+'"]').prop("checked",true)}}else if(typeof t==="boolean"){e.prop("checked",t)}else{e.filter('[value="'+t+'"]').prop("checked",true)}},get:function(e){var t=e.attr("type"),n=e.filter(":checked");if(e.length===1){return!!n.length}if(t==="checkbox"){var r=[];n.each(function(e,t){r.push($(t).val())});return r}else{return n.val()}}},options:{set:function(e,t){e.val(t)},get:function(e){return e.val()||[]}},mod:{set:function(e,t,n,r){var i=this.mods[r];if(i){e.removeClass(i)}i=n+t;this.mods[r]=i;e.addClass(i)},multiple:true}};n.Model=t.Model.extend({_super:t.Model,constructor:function(t,n){this._ribs={computeds:{},computedsDeps:{}};var r=t||{};n=n||{};this.cid=e.uniqueId("c");this.attributes={};if(n.collection){this.collection=n.collection}if(n.parse){r=this.parse(r,n)||{}}r=e.defaults({},r,e.result(this,"defaults"));var i={};for(var s in r){if(r.hasOwnProperty(s)){i[s.replace(/\./g,"!.")]=r[s]}}this.set(i,n);this.changed={};this._initComputeds();this.initialize.apply(this,arguments)},get:function(e){if(typeof e!=="string"){return undefined}var t=this._ribs.computeds;if(e in t){return t[e].get()}var n=i(e);if(n.length===1){return this.attributes[n[0]]}else{return s(n,this.attributes)}},set:function(t,n,r){if(t==null){return this}var u,a,f,l,c,h,p,d,v,m,g,y,b;if(typeof t==="object"){u=t;r=n}else{u={};u[t]=n}r||(r={});if(!this._validate(u,r)){return false}p=r.unset;h=r.silent;a=[];f=this._changing;this._changing=true;var w=this._ribs.computeds,E=e.clone(u),S={},x,T=true,N=true;while(T){T=false;x={};for(m in u){if(u.hasOwnProperty(m)){if(m in w){T=true;e.extend(x,w[m].set(u[m]));if(N){S[m]=u[m]}delete u[m];e.extend(u,x)}}}N=false}if(!f){this._previousAttributes=e.clone(this.attributes);var C={};for(m in w){if(w.hasOwnProperty(m)){C[m]=w[m].value}}e.extend(this._previousAttributes,C);this.changed={}}l=this.attributes;c=this._previousAttributes;if(this.idAttribute in u){this.id=u[this.idAttribute]}for(m in u){if(u.hasOwnProperty(m)){n=u[m];d=i(m);if(!e.isEqual(s(d,l),n)){v=d.slice();for(g=0;g<v.length;g++){v[g]=v[g].replace(/\./g,"!.")}a.push({path:d,escapedPath:v,attr:m,val:n})}if(!e.isEqual(s(d,c),n)){this.changed[m]=n}else{delete this.changed[m]}if(p&&m in E){o(d,l)}else{this._setPath(d,n)}}}for(m in S){if(S.hasOwnProperty(m)&&p){this.removeComputed(m);delete S[m]}}var k=this._ribs.computedsDeps,L=[],A,O;for(g=0,b=a.length;g<b;g++){m=a[g].attr;A=k["change:"+m];if(A){for(y=0;y<A.length;y++){O=A[y];if(L.indexOf(O)===-1){L.push(O)}}}}if(!h){b=a.length;if(b){this._pending=r}for(g=0;g<b;g++){this.trigger("change:"+a[g].attr,this,a[g].val,r);if(r.propagation){v=a[g].escapedPath.slice();if(v.length){while(v.length-1){v.length--;this.trigger("change:"+v.join("."),this,undefined,r)}}}}}for(g=0;g<L.length;g++){w[L[g]].update(r)}if(f){return this}if(!h){while(this._pending){r=this._pending;this._pending=false;this.trigger("change",this,r)}}this._pending=false;this._changing=false;return this},trigger:function(e){var t=this._ribs.computedsDeps,n=arguments[3],i,s;if(typeof e==="string"&&e in t){var o=this._ribs.computeds,u=t[e],a;for(i=0,s=u.length;i<s;i++){a=o[u[i]];a.update(n)}}if(n&&n.silent){return this}return r(this,"trigger",arguments)},_setPath:function(e,t){var n=this.attributes,r;e=e.slice();while(e.length){r=e.shift();if(e.length){if(!(n.hasOwnProperty(r)&&n[r]instanceof Object)){throw new Error("set: can't set anything to \""+r+'", typeof == "'+typeof n[r]+'"')}n=n[r]}else{n[r]=t}}},_initComputeds:function(){var e=this.computeds,t;for(t in e){if(e.hasOwnProperty(t)){this.addComputeds(t,e[t],{silent:true})}}for(t in e){if(e.hasOwnProperty(t)){this._ribs.computeds[t].update()}}},addComputeds:function(e,t,n){var r=this._ribs.computedsDeps,s,o,u,f,l,c,h,p,d,v,m,g,y;if(typeof e==="string"){d={};d[e]=t}else{n=t;d=e}l=n&&n.silent;for(p in d){if(d.hasOwnProperty(p)){if(this.attributes[p]||this._ribs.computeds[p]){throw new Error('addComputeds: computed name "'+p+'" is already used')}u=d[p];s=u.deps;if(s instanceof Array){for(v=0,g=s.length;v<g;v++){c=i(s[v]);o="change:"+c[0].replace(/\./g,"!.");for(m=0,y=c.length;m<y;m++){f=r[o];if(f){if(f.indexOf(p)===-1){f.push(p)}}else{r[o]=[p]}h=c[m+1];if(h){o+="."+h.replace(/\./g,"!.")}}}}u=this._ribs.computeds[p]=new a(u,p,this);if(!l){u.update()}}}return this},addComputed:function(){this.addComputeds.apply(this,arguments)},removeComputed:function(e){this.removeComputeds(e)},removeComputeds:function(e){if(!e){this._ribs.computedsDeps={};this._ribs.computeds={};return this}if(!(e instanceof Array)){e=[e]}var t=this._ribs.computedsDeps,n,r,i,s,o,u;for(o=0,u=e.length;o<u;o++){s=e[o];for(r in t){if(t.hasOwnProperty(r)){n=t[r];i=n.indexOf(s);if(i!==-1){n.splice(i,1)}if(!n.length){delete t[r]}}}delete this._ribs.computeds[s]}return this},toJSON:function(e){var t=r(this,"toJSON",arguments);if(e&&e.computeds){var n=this._ribs.computeds,i;for(var s in n){if(n.hasOwnProperty(s)){i=n[s];t[s]=i._simple?i.get():i.value}}}return t}});n.View=t.View.extend({_super:t.View,constructor:function(t,n){this._ribs={_bindings:e.clone(this.bindings)||{},bindings:{},collections:{}};this.filters=this.filters||{};this.handlers=this.handlers||{};e.extend(this.filters,l);e.extend(this.handlers,c);r(this,"constructor",arguments);if(!this._ribs.preventBindings){this.applyBindings()}},getEl:function(){return this._ribs.outOfDOM?this._$el:this.$el},appendTo:function(e){if(!(e instanceof $)){e=$(e)}e.append(this.getEl())},preventBindings:function(){this._ribs.preventBindings=true},applyBindings:function(){this.addBindings(this._ribs._bindings)},addBindings:function(t,n){var r=this._ribs.bindings,i,s,o,u;if(typeof t==="string"){u={};u[t]=n}else{u=t}for(s in u){if(u.hasOwnProperty(s)){i=u[s];if(typeof i!=="object"||e.isEmpty(i)){throw new Error('wrong binging format for "'+s+'" - '+JSON.stringify(i))}if(r.hasOwnProperty(s)){o=[];for(var a in i){if(i.hasOwnProperty(a)){o.push(a)}}this.removeBindings(s,o)}r[s]=new f(this,s,i)}}},addBinding:function(e,t){this.addBindings.apply(this,arguments)},removeBindings:function(t,n){var r=this._ribs.bindings,i,s;if(typeof t==="string"){s={};s[t]=n}else{s=t}for(var o in r){if(r.hasOwnProperty(o)){if(s){if(s.hasOwnProperty(o)){i=s[o];if(typeof i==="string"){i=[i]}}else{continue}}r[o].unbind(i);if(e.isEmpty(r[o].handlers)){delete r[o]}}}},updateBindings:function(e,t){var n=this._ribs.bindings,r,i;if(typeof e==="string"){i={};i[e]=t}else{i=e}for(var s in n){if(n.hasOwnProperty(s)&&!(i&&!i.hasOwnProperty(s))){if(i){if(i.hasOwnProperty(s)){r=i[s];if(typeof r==="string"){r=[r]}}else{continue}}n[s].update(r)}}},applyCollection:function(e,t,n,r){this.addBindings(e,{collection:{col:t,view:n,data:r}})},renderCollection:function(e,t){var n=this._ribs.bindings,r,i;for(var s in n){if(n.hasOwnProperty(s)&&(!t||t===s)){r=n[s];i=r.handlers.collection;if(i&&(!e||i.collection===e)){r.update(["collection"])}}}},getCollectionViews:function(e){var t=this._ribs.bindings[e];if(t&&t.handlers.collection){return t.handlers.collection.views}return undefined}});return n});Backbone.Model=Backbone.Ribs.Model;
